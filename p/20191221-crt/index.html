<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>中国剩余定理（CRT）及其扩展（ExCRT） - sun123zxy's Blog</title>

        <script src="/assets/thirds/jquery/jquery-3.5.1.min.js"></script>

        <link rel="stylesheet" href="/assets/thirds/katex/katex.min.css">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="/assets/thirds/katex/katex.min.js"></script>
        <!-- To automatically render math in text elements, include the auto-render extension -->
        <script defer src="/assets/thirds/katex/auto-render.min.js" onload="renderMathInElement(document.body)"></script>
        
        <script src="/assets/thirds/highlight/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
    </head>
    <body>
        <div id="home">
    <div id="main" class="panel panel-content">
        <div class="post-body">
    <div class="post-head">
        <h1 id="post-title">中国剩余定理（CRT）及其扩展（ExCRT）</h1>
        <p class="abstract text-vice">
            
                No abstract provided here.
            
        </p>
    </div>
    <div class="post-content"><h2 id="中国剩余定理-crt">中国剩余定理 CRT</h2>
<h3 id="推导">推导</h3>
<blockquote>
<p>给定 <span class="math inline">\(n\)</span> 个同余方程</p>
<p><span class="math display">\[
\left\{
\begin{aligned}
x &amp;\equiv a_1 \pmod{m_1} \\
x &amp;\equiv a_2 \pmod{m_2} \\
&amp;... \\
x &amp;\equiv a_n \pmod{m_n}
\end{aligned}
\right.
\]</span></p>
<p><span class="math inline">\(m_1, m_2 , ... , m_n\)</span>
两两互质</p>
<p>令 <span class="math inline">\(M = \prod_{i=1}^{n} m_i\)</span> ，求
<span class="math inline">\(x \mod M\)</span></p>
</blockquote>
<p>解决该问题的方法是构造。</p>
<p>我们假定最终答案的形式是一个 <span class="math inline">\(n\)</span>
个项的和式，对每个同余方程的构造反应在对应项的系数上。</p>
<p>如果要对每一个项分别构造，就要求为每一项乘上一个合适的数，使得每项构造的系数对其他方程的结果没有影响。</p>
<p>容易想到构造</p>
<p><span class="math display">\[
M_i = \frac{M}{m_i}
\]</span></p>
<p>显然该数仅在模 <span class="math inline">\(m_i\)</span> 时不为 <span
class="math inline">\(0\)</span>
，于是改变该项的系数将不会对其他方程造成影响。</p>
<p>现在我们希望该项模 <span class="math inline">\(m_i\)</span> 意义下是
<span class="math inline">\(a_i\)</span> ，但上一次的构造残留下了一个
<span class="math inline">\(M_i\)</span> 。简单粗暴的乘上 <span
class="math inline">\(M_i\)</span> 在模 <span
class="math inline">\(m_i\)</span> 意义下的逆元 <span
class="math inline">\(\mathrm{inv}_{m_i}(M_i)\)</span> ，让该项在模
<span class="math inline">\(m_i\)</span> 意义下变为 <span
class="math inline">\(1\)</span> ，然后乘上 <span
class="math inline">\(a_i\)</span> 就构造出来了。</p>
<p>综上，答案为</p>
<p><span class="math display">\[
\sum_{i=1}^{n} M_i \mathrm{inv}_{m_i}(M_i) a_i \mod{M}
\]</span></p>
<p>模数互质条件保证了 <span class="math inline">\(M_i\)</span> 在模
<span class="math inline">\(m_i\)</span> 意义下非 <span
class="math inline">\(0\)</span> ，进而保证了 <span
class="math inline">\(\mathrm{inv}_{m_i}(M_i)\)</span> 的存在。</p>
<h3 id="实现">实现</h3>
<p>大部分题的 <span class="math inline">\(m_i\)</span>
都是质数，求逆元快速幂即可。</p>
<p>对于一般的情况，上ExGCD就行。</p>
<p>板题：<a href="https://www.luogu.org/problemnew/show/P1495">洛谷P1495
曹冲养猪</a></p>
<pre class="cpp"><code>#include&lt;iostream&gt;
#include&lt;cstdio&gt;
#include&lt;cstring&gt;
#include&lt;cmath&gt;
#include&lt;ctime&gt;
#include&lt;cstdlib&gt;
#include&lt;algorithm&gt;
#include&lt;queue&gt;
#include&lt;vector&gt;
#include&lt;map&gt;
#include&lt;set&gt;
using namespace std;
typedef long long ll;

namespace ExGcd{
    ll x,y;
    ll ExGcd(ll a,ll b){
        ll ans;
        if(a%b==0){
            x=0;y=1;ans=b;
        }else{
            ans=ExGcd(b,a%b);
            ll x1=x,y1=y;
            x=y1;y=x1-a/b*y1;
        }
        return ans;
    }
    bool SolveEqu(ll a,ll b,ll c){
        ll d=ExGcd(a,b);
        if(c%d!=0) return 0;
        x*=c/d;y*=c/d;
        x=(x%b+b)%b;
        y=(c-a*x)/b;
        return 1;
    }
}
ll Inv(ll a,ll m){
    ExGcd::SolveEqu(a,m,1);
    return ExGcd::x;
}

const ll CRTN=20;
namespace CRT{
    ll N;
    ll m[CRTN],a[CRTN];
    ll Sol(){
        ll ans=0,M=1;
        for(ll i=1;i&lt;=N;i++) M*=m[i];
        for(ll i=1;i&lt;=N;i++){
            ll Mi=M/m[i];
            ans=(ans+Mi*Inv(Mi,m[i])*a[i])%M;
        }
        return ans;
    }
}
int main(){
    using namespace CRT;
    scanf(&quot;%lld&quot;,&amp;N);
    for(ll i=1;i&lt;=N;i++)
        scanf(&quot;%lld%lld&quot;,&amp;m[i],&amp;a[i]);
    printf(&quot;%lld&quot;,Sol());
    return 0;
}</code></pre>
<h2 id="扩展中国剩余定理-excrt">扩展中国剩余定理 ExCRT</h2>
<p>ExCRT和CRT并没有什么关系，<del>正如ExLucas和Lucas也没什么关系</del></p>
<p>其实从纯推理的角度来看，ExCRT可能还要好想一点（</p>
<h3 id="推导-1">推导</h3>
<p>问题同CRT，但是模数是任意的，并不要求互质。</p>
<p>这时，我们就不能保证存在逆元了。那么如何解决该问题呢？</p>
<p>考虑如何合并两个方程。如果我们找到了合并的方法，就能如法炮制将<span
class="math inline">\(n\)</span>个方程依次合并起来，得到答案。</p>
<p><span class="math display">\[
\left\{
\begin{aligned}
x &amp;\equiv a_1 \pmod{m_1} \\
x &amp;\equiv a_2 \pmod{m_2}
\end{aligned}
\right.
\]</span></p>
<p>去掉同余，化为不定方程</p>
<p><span class="math display">\[
\left\{
\begin{aligned}
x &amp;= m_1 y_1 + a_1 \\
x &amp;= m_2 y_2 + a_2
\end{aligned}
\right.
\]</span></p>
<p>于是得到</p>
<p><span class="math display">\[
m_1 y_1 + a_1 = m_2 y_2 + a_2
\]</span></p>
<p>只要找到一组满足该式的 <span class="math inline">\(y_1\)</span> 和
<span class="math inline">\(y_2\)</span> ，就能反算出 <span
class="math inline">\(x\)</span> ，实现合并。</p>
<p>而我们得到的是一个二元一次不定方程，可以用ExGCD求解。</p>
<p>化为标准式</p>
<p><span class="math display">\[
m_1 y_1 - m_2 y_2 = a_2 - a_1
\]</span></p>
<p>解就是了。由裴蜀定理，若 <span class="math inline">\(\gcd(m_1,m_2) |
a_2-a_1\)</span> 不成立，说明同余方程组无解。</p>
<p>于是最后化得的合并式为</p>
<p><span class="math display">\[
x \equiv m_1 y_1 + a_1 \pmod{\mathrm{lcm}(m_1,m_2)}
\]</span></p>
<h4 id="update-20201202-关于合并后的模数">Update 2020/12/02
关于合并后的模数</h4>
<p>之前没有讲清楚 <span
class="math inline">\(\pmod{\mathrm{lcm}(m_1,m_2)}\)</span>
是怎么来的，这里补充一笔。</p>
<p>根据二元一次不定方程理论， <span class="math inline">\(y_1\)</span>
的通解形式应为 <span class="math inline">\(y_1 = y + k
\frac{m_2}{\gcd(m_1,m_2)}\)</span> （ <span
class="math inline">\(y\)</span> 是某一个特解），此时带回得到 <span
class="math inline">\(x =k \frac{m_1 m_2}{\gcd(m_1,m_2)} + m_1 y +
a_1\)</span> ，模上个 <span class="math inline">\(\mathrm{lcm}(m_1,m_2)
= \frac{m_1 m_2}{\gcd(m_1,m_2)}\)</span> 就是最终的合并式了。</p>
<h3 id="实现-1">实现</h3>
<p>唯一需要注意的地方是，本来解方程应该解 <span
class="math inline">\((m_1,-m_2,a_2-a_1)\)</span>
，但ExGCD不好处理负数，所以把 <span class="math inline">\(- m_2\)</span>
改成了 <span class="math inline">\(m_2\)</span> 。因为我们并不需要用到
<span class="math inline">\(y_2\)</span> ，所以不会影响求解。</p>
<p>板题：<a href="http://poj.org/problem?id=2891">poj2891 Strange Way to
Express Integers</a> or <a
href="https://www.luogu.com.cn/problem/P4777">洛谷P4777
扩展中国剩余定理（EXCRT）</a></p>
<p>会被卡乘法爆ll，<del>懒得改</del></p>
<pre class="cpp"><code>#include&lt;iostream&gt;
#include&lt;cstdio&gt;
#include&lt;cstring&gt;
#include&lt;cmath&gt;
#include&lt;ctime&gt;
#include&lt;cstdlib&gt;
#include&lt;algorithm&gt;
#include&lt;queue&gt;
#include&lt;vector&gt;
#include&lt;map&gt;
#include&lt;set&gt;
using namespace std;
typedef long long ll;

namespace ExGcd{
    ll x,y;
    ll ExGcd(ll a,ll b){
        ll ans;
        if(a%b==0){
            x=0;y=1;ans=b;
        }else{
            ans=ExGcd(b,a%b);
            ll x1=x,y1=y;
            x=y1;y=x1-a/b*y1;
        }
        return ans;
    }
    bool SolveEqu(ll a,ll b,ll c){
        ll d=ExGcd(a,b);
        if(c%d!=0) return 0;
        x*=c/d;y*=c/d;
        x=(x%b+b)%b;
        y=(c-a*x)/b;
        return 1;
    }
}
ll Gcd(ll a,ll b){
    if(a%b==0) return b;
    return Gcd(b,a%b);
}
namespace ExCRT{
    ll a1,m1;
    void Init(){
        a1=0;m1=1;
    }
    void Expand(ll a2,ll m2){
        ExGcd::SolveEqu(m1,m2,a2-a1);
        ll y1=ExGcd::x;
        ll mn=m1*m2/Gcd(m1,m2);
        a1=(m1*y1+a1)%mn;
        m1=mn;
    }
}
int main(){
    ll N;scanf(&quot;%lld&quot;,&amp;N);
    ExCRT::Init();
    for(ll i=1;i&lt;=N;i++){
        ll a,m;scanf(&quot;%lld%lld&quot;,&amp;m,&amp;a);
        ExCRT::Expand(a,m);
    }
    printf(&quot;%lld&quot;,ExCRT::a1);
    return 0;
}</code></pre>
</div>
    <div class="post-tags text-vice" style="text-align: right">
        <p>tags: 
            
                <a href= "/tags#OI" >OI</a>, 
            
                <a href= "/tags#数学" >数学</a>, 
            
                <a href= "/tags#学习笔记" >学习笔记</a>
            
        </p>
        <p>posted on 2019/12/21 | last modified on 2020/12/02</p>
    </div>
    
        <div class="post-comments">
            <script src="https://giscus.app/client.js"
                data-repo="sun123zxy/sun123zxy.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnkzMTAwMzQxNDc="
                data-category="General"
                data-category-id="DIC_kwDOEnq-484CQKFr"
                data-mapping="pathname"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="en"
                crossorigin="anonymous">
            </script>
        </div>
    
</div>
    </div>
    <div id="sidebar">
        
            <div id="sidebar-profile" class="panel">
                
                <div class="panel-content">
                    <a href="/"><img class="avatar" src="/assets/images/pig.png"></img></a>
<p class="nickname">sun123zxy</p>
<div class="nav">
    <a href="/">Home</a> | 
    <a href="/p/aboutme">About</a> | 
    <a href="/tags">Tags</a>
</div>
<div class="feed">
    <img src="/assets/images/feed.png"></img>
    <a href="/feed.xml">Atom Feed</a>
</div>
<p>Next Phantasm...</p>
                </div>
            </div>
        
            <div id="sidebar-news" class="panel">
                
                <h2 class="panel-title">News</h2>
                
                <div class="panel-content">
                    <a href="https://info.flagcounter.com/1Zpv"><img src="https://s05.flagcounter.com/count2/1Zpv/bg_DDDDDD/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_3/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>

<p>博客已迁移。访问 <a href="https://blog.sun123zxy.top">blog.sun123zxy.top</a> 获取更多信息。</p>
                </div>
            </div>
        
            <div id="sidebar-links" class="panel">
                
                <h2 class="panel-title">Links</h2>
                
                <div class="panel-content">
                    
<h3>My Friends</h3>
<ul>
    <li><a href="https://www.cnblogs.com/Railgunforever">吸取教训</a></li>
    <li><a href="https://p9t6g.github.io">p9t6g</a></li>
    <li><a href="https://tbyangz.github.io">TbYangZ</a></li>
    <li><a href="https://www.cnblogs.com/ALANALLEN21LOVE28">CJ SYH</a></li>
</ul>

<h3>Related Sites</h3>
<ul>
    <li><a href="http://www.cnblogs.com/sun123zxy">博客园</a></li>
    <li><a href="http://tools.sun123zxy.top">工具站</a></li>
</ul>
                </div>
            </div>
        
            <div id="sidebar-tags" class="panel">
                
                <h2 class="panel-title">Tags</h2>
                
                <div class="panel-content">
                    <ul>
    
    <li><a href= "/tags#OI" >OI</a></li>
    
    <li><a href= "/tags#数学" >数学</a></li>
    
    <li><a href= "/tags#高考" >高考</a></li>
    
    <li><a href= "/tags#题解" >题解</a></li>
    
    <li><a href= "/tags#原创题目" >原创题目</a></li>
    
    <li><a href= "/tags#学习笔记" >学习笔记</a></li>
    
    <li><a href= "/tags#意识流" >意识流</a></li>
    
    <li><a href= "/tags#游记" >游记</a></li>
    
    <li><a href= "/tags#Web" >Web</a></li>
    
    <li><a href= "/tags#站点相关" >站点相关</a></li>
    
    <li><a href= "/tags#Python" >Python</a></li>
    
</ul>
                </div>
            </div>
        
        
            <div id="contents" class="panel"><h2 class="panel-title">Contents</h2>
<div class="panel-content"></div>
<script defer src="/assets/js/contents.js"></script></div>
        
    </div>
    <div class="fclean"></div>
    <div id="footer" class="text-vice">
        <p>sun123zxy's Blog | Powered by Jekyll</p>
    </div>
</div>
<div id="leftdown-float-container">
    <div id="theme-info" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/info.png"></img></div>
        <div class="hover-info">Theme Info</div>
    </div>
    <div id="theme-switch" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/switch.png"></img></div>
        <div class="hover-info">Theme Switch</div>
    </div>
</div>
<div id="rightdown-float-container">
    <div id="music-player" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/music.png"></img></div>
        <div class="hover-info">Music Player</div>
    </div>
</div>
<link rel="stylesheet" href="/assets/css/default.css">
<link rel="stylesheet" id="night-container">
<link rel="stylesheet" id="theme-container">
<div id="mask"></div>
<script src="/assets/js/theme_data.js"></script>
<script src="/assets/js/round_button.js"></script>
<script src="/assets/js/theme_manager.js" defer></script>
<script src="/assets/js/music_player.js"></script>
<script src="/assets/js/scroll.js"></script>
    </body>
</html>