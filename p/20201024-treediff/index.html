<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>树上差分的两种形式（相遇 or 行程的交集 题解） - sun123zxy's Blog</title>

        <script src="/assets/thirds/jquery/jquery-3.5.1.min.js"></script>

        <link rel="stylesheet" href="/assets/thirds/katex/katex.min.css">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="/assets/thirds/katex/katex.min.js"></script>
        <!-- To automatically render math in text elements, include the auto-render extension -->
        <script defer src="/assets/thirds/katex/auto-render.min.js" onload="renderMathInElement(document.body)"></script>
        
        <script src="/assets/thirds/highlight/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
    </head>
    <body>
        <div id="home">
    <div id="main" class="panel panel-content">
        <div class="post-body">
    <div class="post-head">
        <h1 id="post-title">树上差分的两种形式（相遇 or 行程的交集 题解）</h1>
        <p class="abstract text-vice">
            
                No abstract provided here.
            
        </p>
    </div>
    <div class="post-content"><p>emm，这很NOIP...</p>
<p>写这个的原因是今天考试一个sb差分树题居然杠了个树剖上去，杀鸡用了牛刀。</p>
<p>而且不止一次了...总是想不到子树和这种差分，淦</p>
<p>Anyway，简单写写吧。</p>
<h2 id="树上差分的两种形式">树上差分的两种形式</h2>
<ul>
<li><p><strong>单点修改&amp;链查询</strong>用差分转化为<strong>单点修改&amp;树上前缀和</strong></p>
<pre class="cpp"><code>class MPQU{public: //单点修改 &amp; 树上前缀和 (Modify Point Query Up)
  BIT bit;
  MPQU(bool typ=0){if(typ==1) bit=BIT(dN);}
  void Add(ll u,ll w){bit.Add(st[u],w); bit.Add(ed[u],-w);}
  ll Query(ll u){return bit.Query(st[u]);}
};
class MPQL{public: //单点修改 &amp; 链查询 (Modify Point Query Link)
  MPQU mpqu;
  MPQL(bool typ=0){if(typ==1) mpqu=MPQU(1);}
  void Add(ll u,ll w){mpqu.Add(u,w);}
  ll Query(ll u,ll v){ll lca=LCA(u,v); return mpqu.Query(u)+mpqu.Query(v)-mpqu.Query(lca)-mpqu.Query(fa[lca]);}
}mpql;</code></pre></li>
<li><p><strong>链修改&amp;单点查询</strong>用差分转化为<strong>单点修改&amp;子树和</strong></p>
<pre class="cpp"><code>class MPQD{public: //单点修改 &amp; 子树和 (Modify Point Query Down)
  BIT bit;
  MPQD(bool typ=0){if(typ==1) bit=BIT(dN);} 
  void Add(ll u,ll w){bit.Add(st[u],w);}
  ll Query(ll u){return bit.Query(ed[u])-bit.Query(st[u]-1);}
};
class MLQP{public: //链修改 &amp; 单点查询 (Modify Link Query Point)
  MPQD mpqd;
  MLQP(bool typ=0){if(typ==1) mpqd=MPQD(1);}
  void Add(ll u,ll v){ll lca=LCA(u,v); mpqd.Add(u,1); mpqd.Add(v,1); mpqd.Add(lca,-1); mpqd.Add(fa[lca],-1);}
  ll Query(ll u){return mpqd.Query(u);}
}mlqp;</code></pre></li>
</ul>
<p><del>三重封装</del></p>
<p>转化后的问题都能用<strong>DFS序+树状数组</strong>解决。（在上文代码中，树状数组用<code>BIT</code>封装，<code>st, ed</code>是DFS序）</p>
<p>本质：</p>
<ul>
<li><p><strong>树上前缀和</strong>对应<strong>序列前缀和</strong></p></li>
<li><p><strong>子树和</strong>对应<strong>序列后缀和</strong></p></li>
</ul>
<p>在序列上，前缀和、后缀和均能解决这两个问题。</p>
<p>而之所以在树上这两种形式求解的问题出现不同，是因为与序列相比，树是上小下大的。</p>
<h2 id="相遇-or-行程的交集-题解">相遇 or 行程的交集 题解</h2>
<p>这道题综合的考察了两种差分，成功把我干翻（</p>
<p><a
href="https://oj.bashu.com.cn/code/problempage.php?problem_id=5960">[出处不明]
相遇 or 行程的交集</a></p>
<blockquote>
<p>Description</p>
<p>　　豪哥生活在一个n个点的树形城市里面，每一天都要走来走去。虽然走的是比较的多，但是豪哥在这个城市里面的朋友并不是很多。</p>
<p>　　当某一天，猴哥给他展现了一下大佬风范之后，豪哥决定要获得一些交往机会来提升交往能力。豪哥现在已经物色上了一条友，打算和它（豪哥并不让吃瓜群众知道性别）交往。豪哥现在spy了一下这个人的所有行程起点和终点，豪哥打算从终点开始走到起点与其相遇。但是豪哥是想找话题的，他想知道以前有多少次行程和此次行程是有交集的，这样豪哥就可以搭上话了。这个路径与之前路径的有交集数量作为豪哥此次的交往机会。</p>
<p>　　但是豪哥急着要做交往准备，所以算什么交往机会的小事情就交给你了。</p>
<p>Input</p>
<p>　　第一行一个正整数n表示节点个数。</p>
<p>　　接下来n-1行，每行两个正整数分别是u，v表示节点u和v之间有连边。</p>
<p>　　接下来一行一个 正整数m表示路径个数。</p>
<p>　　然后有m行，每行两个正整数分别是u，v分别表示u到v之间有一条路径。</p>
<p>Output</p>
<p>　　输出共m行，每行一个整数，第i行表示豪哥在这条路径上获得的交往机会。</p>
<p>Sample Input</p>
<pre><code>5
1 2
1 3
3 4
3 5
4
4 5
4 2
1 3
1 2</code></pre>
<p>Sample Output</p>
<pre><code>0
1
2
2</code></pre>
<p>Hint</p>
<p>【数据范围与约定】</p>
<p>　　对于20%的数据n，m≤2000</p>
<p>　　对于另外20%的数据n，m≤50000</p>
<p>　　对于另外10%的数据n，m≤200000，保证树形结构是一条链</p>
<p>　　对于另外50%的数据n，m≤200000</p>
</blockquote>
<p>简要题意：给你一棵树，然后按顺序输入若干条路径。问每次输入路径时该路径与前面已经输入的多少条路径有交集。</p>
<p>主要要想到把<strong>两条树上路径有交集</strong>转换为<strong>其中某条路径的LCA被另一条路径所覆盖</strong>。</p>
<p>于是对于当前输入的路径，分<strong>当前路径覆盖了多少个之前路径的LCA</strong>和<strong>当前路径的LCA被之前多少个路径覆盖</strong>讨论即可。前者是<strong>单点修改&amp;链查询</strong>，后者是<strong>链修改&amp;单点查询</strong>，按前文的方法做就可以了。</p>
<p>注意特判LCA重叠的情况，见代码。</p>
<pre class="cpp"><code>#include&lt;iostream&gt;
#include&lt;cstdio&gt;
#include&lt;cmath&gt;
#include&lt;cstring&gt;
#include&lt;ctime&gt;
#include&lt;cstdlib&gt;
#include&lt;queue&gt;
#include&lt;algorithm&gt;
#include&lt;map&gt;
#include&lt;set&gt;
#include&lt;vector&gt;
using namespace std;
typedef long long ll;
typedef vector&lt;ll&gt; Vector;
typedef vector&lt;ll&gt;::iterator VecIt;
ll Rd(){
    ll ans=0;bool fh=0;char c=getchar();
    while(c&lt;&#39;0&#39;||c&gt;&#39;9&#39;){if(c==&#39;-&#39;) fh=1; c=getchar();}
    while(c&gt;=&#39;0&#39;&amp;&amp;c&lt;=&#39;9&#39;) ans=ans*10+c-&#39;0&#39;,c=getchar();
    if(fh) ans=-ans;
    return ans;
}

ll Lowbit(ll x){return x&amp;(-x);}

const ll PTN=2E5+5; 
class BIT{public: 
    vector&lt;ll&gt; tr;ll n;
    BIT(){}
    BIT(ll n){this-&gt;n = n; tr=vector&lt;ll&gt;(n+1,0);}
    void Add(ll p,ll w){
        if(!p) return;
        for(ll i=p;i&lt;=n;i+=Lowbit(i)) tr[i]+=w;
    }
    ll Query(ll p){
        ll ans=0;
        for(ll i=p;i&gt;=1;i-=Lowbit(i)) ans+=tr[i];
        return ans;
    }
};

ll N;
Vector edge[PTN];
ll fa[PTN],dep[PTN],sz[PTN],son[PTN];
ll st[PTN],ed[PTN];ll dN;
void DFS1(ll u,ll father,ll depth){
    fa[u]=father;dep[u]=depth;sz[u]=1;son[u]=0;st[u]=++dN;
    for(VecIt it = edge[u].begin(); it!=edge[u].end(); it++){
        ll v=(*it);if(v==father) continue;
        DFS1(v,u,depth+1);
        sz[u]+=sz[v];
        if(sz[v]&gt;sz[son[u]]) son[u]=v;
    }
    ed[u]=++dN;
}
ll tp[PTN];
void DFS2(ll u,ll toop){
    tp[u]=toop;
    if(son[u]) DFS2(son[u],toop);
    for(VecIt it = edge[u].begin(); it!=edge[u].end(); it++){
        ll v=(*it);if(v==fa[u]) continue;
        if(v!=son[u]) DFS2(v,v);
    }
}
ll LCA(ll u,ll v){
    while(tp[u]!=tp[v]){
        if(dep[tp[u]]&lt;dep[tp[v]]) swap(u,v);
        u=fa[tp[u]];
    }
    if(dep[u]&lt;dep[v]) return u;
    else return v;
}

class MPQU{public: //单点修改 &amp; 树上前缀和 (Modify Point Query Up)
    BIT bit;
    MPQU(bool typ=0){if(typ==1) bit=BIT(dN);}
    void Add(ll u,ll w){bit.Add(st[u],w); bit.Add(ed[u],-w);}
    ll Query(ll u){return bit.Query(st[u]);}
};
class MPQD{public: //单点修改 &amp; 子树和 (Modify Point Query Down)
    BIT bit;
    MPQD(bool typ=0){if(typ==1) bit=BIT(dN);} 
    void Add(ll u,ll w){bit.Add(st[u],w);}
    ll Query(ll u){return bit.Query(ed[u])-bit.Query(st[u]-1);}
};
class MPQL{public: //单点修改 &amp; 链查询 (Modify Point Query Link)
    MPQU mpqu;
    MPQL(bool typ=0){if(typ==1) mpqu=MPQU(1);}
    void Add(ll u,ll w){mpqu.Add(u,w);}
    ll Query(ll u,ll v){ll lca=LCA(u,v); return mpqu.Query(u)+mpqu.Query(v)-mpqu.Query(lca)-mpqu.Query(fa[lca]);}
}mpql;
class MLQP{public: //链修改 &amp; 单点查询 (Modify Link Query Point)
    MPQD mpqd;
    MLQP(bool typ=0){if(typ==1) mpqd=MPQD(1);}
    void Add(ll u,ll v){ll lca=LCA(u,v); mpqd.Add(u,1); mpqd.Add(v,1); mpqd.Add(lca,-1); mpqd.Add(lca,-1);/*mpqd.Add(fa[lca],-1);*/} //特殊处理重叠LCA 
    ll Query(ll u){return mpqd.Query(u);}
}mlqp;
int main(){
    //freopen(&quot;meet.in&quot;,&quot;r&quot;,stdin);
    //freopen(&quot;meet.out&quot;,&quot;w&quot;,stdout);
    N=Rd();
    for(ll i=1;i&lt;N;i++){
        ll u=Rd(),v=Rd();
        edge[u].push_back(v);
        edge[v].push_back(u);
    }
    dN=0;sz[0]=0;DFS1(1,0,0);
    DFS2(1,1);
    st[0]=0;ed[0]=0;
    mpql=MPQL(1);mlqp=MLQP(1); 
    ll qN=Rd();
    for(ll q=1;q&lt;=qN;q++){
        ll u=Rd(),v=Rd();
        ll lca=LCA(u,v);
        
        printf(&quot;%lld\n&quot;,mpql.Query(u,v)+mlqp.Query(lca));
        mpql.Add(lca,1);
        mlqp.Add(u,v);
    }
    return 0;
}</code></pre>
</div>
    <div class="post-tags text-vice" style="text-align: right">
        <p>tags: 
            
                <a href= "/tags#OI" >OI</a>, 
            
                <a href= "/tags#学习笔记" >学习笔记</a>, 
            
                <a href= "/tags#题解" >题解</a>
            
        </p>
        <p>posted on 2020/10/24 | last modified on 2020/10/24</p>
    </div>
    
        <div class="post-comments">
            <script src="https://giscus.app/client.js"
                data-repo="sun123zxy/sun123zxy.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnkzMTAwMzQxNDc="
                data-category="General"
                data-category-id="DIC_kwDOEnq-484CQKFr"
                data-mapping="pathname"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="en"
                crossorigin="anonymous">
            </script>
        </div>
    
</div>
    </div>
    <div id="sidebar">
        
            <div id="sidebar-profile" class="panel">
                
                <div class="panel-content">
                    <a href="/"><img class="avatar" src="/assets/images/pig.png"></img></a>
<p class="nickname">sun123zxy</p>
<div class="nav">
    <a href="/">Home</a> | 
    <a href="/p/aboutme">About</a> | 
    <a href="/tags">Tags</a>
</div>
<div class="feed">
    <img src="/assets/images/feed.png"></img>
    <a href="/feed.xml">Atom Feed</a>
</div>
<p>Next Phantasm...</p>
                </div>
            </div>
        
            <div id="sidebar-news" class="panel">
                
                <h2 class="panel-title">News</h2>
                
                <div class="panel-content">
                    <a href="https://info.flagcounter.com/1Zpv"><img src="https://s05.flagcounter.com/count2/1Zpv/bg_DDDDDD/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_3/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>

<p>博客已迁移。访问 <a href="https://blog.sun123zxy.top">blog.sun123zxy.top</a> 获取更多信息。</p>
                </div>
            </div>
        
            <div id="sidebar-links" class="panel">
                
                <h2 class="panel-title">Links</h2>
                
                <div class="panel-content">
                    
<h3>My Friends</h3>
<ul>
    <li><a href="https://www.cnblogs.com/Railgunforever">吸取教训</a></li>
    <li><a href="https://p9t6g.github.io">p9t6g</a></li>
    <li><a href="https://tbyangz.github.io">TbYangZ</a></li>
    <li><a href="https://www.cnblogs.com/ALANALLEN21LOVE28">CJ SYH</a></li>
</ul>

<h3>Related Sites</h3>
<ul>
    <li><a href="http://www.cnblogs.com/sun123zxy">博客园</a></li>
    <li><a href="http://tools.sun123zxy.top">工具站</a></li>
</ul>
                </div>
            </div>
        
            <div id="sidebar-tags" class="panel">
                
                <h2 class="panel-title">Tags</h2>
                
                <div class="panel-content">
                    <ul>
    
    <li><a href= "/tags#OI" >OI</a></li>
    
    <li><a href= "/tags#数学" >数学</a></li>
    
    <li><a href= "/tags#高考" >高考</a></li>
    
    <li><a href= "/tags#题解" >题解</a></li>
    
    <li><a href= "/tags#原创题目" >原创题目</a></li>
    
    <li><a href= "/tags#学习笔记" >学习笔记</a></li>
    
    <li><a href= "/tags#意识流" >意识流</a></li>
    
    <li><a href= "/tags#游记" >游记</a></li>
    
    <li><a href= "/tags#Web" >Web</a></li>
    
    <li><a href= "/tags#站点相关" >站点相关</a></li>
    
    <li><a href= "/tags#Python" >Python</a></li>
    
</ul>
                </div>
            </div>
        
        
            <div id="contents" class="panel"><h2 class="panel-title">Contents</h2>
<div class="panel-content"></div>
<script defer src="/assets/js/contents.js"></script></div>
        
    </div>
    <div class="fclean"></div>
    <div id="footer" class="text-vice">
        <p>sun123zxy's Blog | Powered by Jekyll</p>
    </div>
</div>
<div id="leftdown-float-container">
    <div id="theme-info" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/info.png"></img></div>
        <div class="hover-info">Theme Info</div>
    </div>
    <div id="theme-switch" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/switch.png"></img></div>
        <div class="hover-info">Theme Switch</div>
    </div>
</div>
<div id="rightdown-float-container">
    <div id="music-player" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/music.png"></img></div>
        <div class="hover-info">Music Player</div>
    </div>
</div>
<link rel="stylesheet" href="/assets/css/default.css">
<link rel="stylesheet" id="night-container">
<link rel="stylesheet" id="theme-container">
<div id="mask"></div>
<script src="/assets/js/theme_data.js"></script>
<script src="/assets/js/round_button.js"></script>
<script src="/assets/js/theme_manager.js" defer></script>
<script src="/assets/js/music_player.js"></script>
<script src="/assets/js/scroll.js"></script>
    </body>
</html>