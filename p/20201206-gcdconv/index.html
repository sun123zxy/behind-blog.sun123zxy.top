<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>原创OI题目 GCD卷积 Problem and Solution - sun123zxy's Blog</title>

        <script src="/assets/thirds/jquery/jquery-3.5.1.min.js"></script>

        <link rel="stylesheet" href="/assets/thirds/katex/katex.min.css">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="/assets/thirds/katex/katex.min.js"></script>
        <!-- To automatically render math in text elements, include the auto-render extension -->
        <script defer src="/assets/thirds/katex/auto-render.min.js" onload="renderMathInElement(document.body)"></script>
        
        <script src="/assets/thirds/highlight/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
    </head>
    <body>
        <div id="home">
    <div id="main" class="panel panel-content">
        <div class="post-body">
    <div class="post-head">
        <h1 id="post-title">原创OI题目 GCD卷积 Problem and Solution</h1>
        <p class="abstract text-vice">
            
                No abstract provided here.
            
        </p>
    </div>
    <div class="post-content"><p>比赛用题面、题解、标程和数据生成器均已挂在 <a
href="https://github.com/sun123zxy/gcdconv">git@github.com:sun123zxy/gcdconv.git</a>
上。</p>
<h2 id="problem">Problem</h2>
<blockquote>
<p><strong>GCD卷积 (gcdconv.cpp/.in/.out) (1s,512MB)</strong></p>
<p><strong>Description</strong></p>
<p>定义一种新的卷积 —— GCD卷积，其接受两个长度为 <span
class="math inline">\(n\)</span> 的序列 <span
class="math inline">\(f,g\)</span> ，依据下式生成长度为 <span
class="math inline">\(n\)</span> 的序列 <span
class="math inline">\(h\)</span> ： <span class="math display">\[
h_k = \sum_{\gcd(i,j) = k} f_i g_j
\]</span> 现给定序列 <span class="math inline">\(f,g\)</span> ，求各
<span class="math inline">\(h_i\)</span> 对 <span
class="math inline">\(998244353\)</span> 取模后的值。</p>
<p><strong>Input</strong></p>
<p>第一行输入一个正整数 <span class="math inline">\(n\)</span> ，表示
<span class="math inline">\(f,g\)</span> 的长度。</p>
<p>第二行输入 <span class="math inline">\(n\)</span> 个整数 <span
class="math inline">\(f_i\)</span> 。</p>
<p>第三行输入 <span class="math inline">\(n\)</span> 个整数 <span
class="math inline">\(g_i\)</span> 。</p>
<p><strong>Output</strong></p>
<p>为减少输出量，只需输出1个整数，表示各 <span
class="math inline">\(h_i\)</span> 对 <span
class="math inline">\(998244353\)</span> 取模后的异或和。</p>
<p><strong>Sample 1</strong></p>
<p><strong>Sample 1 Input</strong></p>
<pre><code>3
5 1 4
2 3 3</code></pre>
<p><strong>Sample 1 Output</strong></p>
<pre><code>78</code></pre>
<p><strong>Sample 1 Explanation</strong> <span class="math display">\[
\begin{aligned}
h_1 &amp;= f_1 ( g_1 + g_2 + g_3 ) + g_1 (f_2 + f_3) + f_2 g_3 + f_3 g_2
= 65 \\
h_2 &amp;= f_2 g_2 = 3 \\
h_3 &amp;= f_3 g_3 = 12
\end{aligned}
\]</span></p>
<p><span class="math display">\[
65 \oplus 3 \oplus 12 = 78
\]</span></p>
<p><strong>Sample 2</strong></p>
<p><strong>Sample 2 Input</strong></p>
<pre><code>4
7 1 8 0
6 2 9 1</code></pre>
<p><strong>Sample 2 Output</strong></p>
<pre><code>158</code></pre>
<p><strong>Sample 2 Explanation</strong> <span class="math display">\[
\begin{aligned}
h_1 &amp;= 213 \\
h_2 &amp;= 3 \\
h_3 &amp;= 72 \\
h_4 &amp;= 0
\end{aligned}
\]</span></p>
<p><span class="math display">\[
213 \oplus 3 \oplus 72 \oplus 0 = 158
\]</span></p>
<p><strong>Sample 3</strong></p>
<p>见 <code>sample</code> 目录下 <code>gcdconv3.in/.ans</code> 。</p>
<p><strong>Constraints</strong></p>
<p>对20%的数据，<span class="math inline">\(1 \le n \le 2000\)</span>
。</p>
<p>对100%的数据， <span class="math inline">\(1 \le n \le 4 \times
10^5\)</span> ， <span class="math inline">\(0 \le f_i, g_i \le
998244352\)</span> 。</p>
<p><strong>Hints</strong></p>
<p>时限在std的1.5倍左右。std没有卡常，数据有一定梯度，请放心食用。</p>
<p><strong>Source</strong></p>
<p>sun123zxy</p>
</blockquote>
<h2 id="section">???</h2>
<ul>
<li>样例2比较暴力。</li>
</ul>
<h2 id="记号说明">记号说明</h2>
<p>默认诸如 <span class="math inline">\(n,d,i,j,k\)</span>
的下标变量的最大值为题目中的给出的序列长度，并把序列更换为数论函数来表示。</p>
<p>注意本题解中的 <span class="math inline">\(n\)</span>
通常是一个变量，和题目中定义的序列长度 <span
class="math inline">\(n\)</span> 不同。</p>
<p>另外，用 <span class="math inline">\(\circ\)</span> 代表 <span
class="math inline">\(\gcd\)</span> 卷积，即 <span
class="math display">\[
h(n) = (f \circ g)(n) = \sum_{\gcd(i,j) = n} f(i) g(j)
\]</span></p>
<h2 id="solution">Solution</h2>
<p>我们按照快速傅里叶变换（FFT）、快速莫比乌斯变换（FMT）解决卷积的思路来解决该问题——构造一种变换来满足卷积定理：</p>
<p><span class="math display">\[
\hat f(n) \hat g(n) = \widehat {(f \circ g)}(n)
\]</span> <span class="math inline">\(\hat f\)</span> 即对函数 <span
class="math inline">\(f\)</span> 进行该变换后得到的函数。</p>
<p>通过一些敏锐的直觉，我们能感受到 <span
class="math inline">\(\gcd\)</span> 和枚举约数或者倍数有一些关系。</p>
<p>容易想到构造出一种变换，称之为“倍数和变换”： <span
class="math display">\[
\hat f(n) = \sum_{n|d} f(d)
\]</span> 并根据莫比乌斯反演得到它的逆变换 <span class="math display">\[
f(n) = \sum_{n|d} \mu(\frac n d) \hat f(d)
\]</span> （这实际上是标准莫比乌斯反演的另一种形式，详见后文 <a
href="#Further%20Thoughts">Further Thoughts</a> ）</p>
<p>这个变换对 <span class="math inline">\(\gcd\)</span>
卷积满足卷积定理，证明如下。</p>
<p>首先，写出 <span class="math inline">\(\gcd\)</span> 卷积 <span
class="math display">\[
h(k) = (f \circ g)(k) = \sum_{i,j} [\gcd(i,j)=k] f(i) g(j)
\]</span> 左右两边做倍数和变换： <span class="math display">\[
\begin{aligned}
\hat h(n) &amp;= \sum_{n|k} \sum_{i,j} [\gcd(i,j)=k] f(i) g(j) \\
&amp;= \sum_{i,j} \left( \sum_{n|k} [\gcd(i,j)=k] \right) f(i) g(j)
\quad \\
&amp;= \sum_{i,j} [n|i][n|j] f(i) g(j) \quad \\
&amp;= \sum_{n|i} f(i) \sum_{n|j} g(j) \quad \\
&amp;= \hat f(n) \hat g(n)
\end{aligned}
\]</span> 得证。上述证明的核心在于 <span
class="math inline">\(\sum_{n|k} [\gcd(i,j)=k] = [n|i] [n|j]\)</span>
。</p>
<p>于是，先对 <span class="math inline">\(f,g\)</span>
做倍数和变换，然后直接 <span class="math inline">\(O(n)\)</span>
点值相乘，再逆变换回来，就能得到 <span class="math inline">\(f \circ
g\)</span> 。</p>
<p>那么剩下的问题在于如何快速做倍数和变换及其逆变换。这是非常simple的，直接暴力就好了。复杂度为
<span class="math inline">\(O(n H(n))\)</span> ，其中调和级数 <span
class="math inline">\(H(n)= \sum_{k=1}^{n} \frac 1 k\)</span> ，有 <span
class="math inline">\(\lim_{n \to \infty} H(n) = \ln(n) + c\)</span>
。欧拉常数 <span class="math inline">\(c \approx
0.57721566490153286060651209\)</span> 。</p>
<p>可以称之为“快速倍数和变换”。</p>
<p>总时间复杂度约为 <span class="math inline">\(O(n \ln n)\)</span>
。</p>
<h2 id="code">Code</h2>
<pre class="cpp"><code>/*
gcd卷积 (gcdconv) std
by sun123zxy 
*/
#include&lt;iostream&gt;
#include&lt;cstdio&gt;
#include&lt;cmath&gt;
#include&lt;cstring&gt;
#include&lt;ctime&gt;
#include&lt;cstdlib&gt;
#include&lt;queue&gt;
#include&lt;vector&gt;
#include&lt;map&gt;
#include&lt;set&gt;
using namespace std;
typedef long long ll;

ll Rd(){
    ll ans=0;bool fh=0;char c=getchar();
    while(c&lt;&#39;0&#39;||c&gt;&#39;9&#39;){if(c==&#39;-&#39;) fh=1; c=getchar();}
    while(c&gt;=&#39;0&#39;&amp;&amp;c&lt;=&#39;9&#39;) ans=ans*10+c-&#39;0&#39;,c=getchar();
    if(fh) ans=-ans;
    return ans;
}

const ll MOD=998244353;
#define _ %MOD
ll PMod(ll x){
    if(x&lt;0) return x+MOD;
    else if(x&gt;=MOD) return x-MOD;
    else return x;
}

const ll MXN=5E5+5;
ll P[MXN],mu[MXN];ll pN;
bool notP[MXN];
void LinearSieve(ll n){
    notP[1]=1;for(ll i=2;i&lt;=n;i++) notP[i]=0;
    P[1]=0;mu[1]=1;
    pN=0;
    for(ll i=2;i&lt;=n;i++){
        if(!notP[i]){
            P[++pN]=i;
            mu[i]=-1;
        }
        for(ll j=1;i*P[j]&lt;=n;j++){
            notP[i*P[j]]=1;
            if(i%P[j]==0){
                mu[i*P[j]]=0;
                break;
            }
            mu[i*P[j]]=mu[i]*mu[P[j]];
        }
    }
}

class Poly{public:
    ll&amp; operator [] (ll idx){return cof[idx];}
    ll n;vector&lt;ll&gt; cof;
    Poly(){}
    Poly(ll n){Resize(n);}
    void Resize(ll n){
        this-&gt;n = n;
        cof.resize(n+1,0);
    }
};
namespace PC{//PolyCalc
    void FMT(Poly&amp; A,ll typ){
        ll n=A.n;
        Poly B(n);
        for(ll i=1;i&lt;=n;i++){
            for(ll j=1;i*j&lt;=n;j++){
                ll t=A[i*j];if(typ==-1) t=t*mu[j]_;
                B[i]=PMod(B[i]+t);
            }
        }
        A=B;
    }
    Poly GcdConv(Poly A,Poly B){
        ll n=min(A.n,B.n); 
        Poly C(n);
        FMT(A,1);FMT(B,1);
        for(ll i=1;i&lt;=n;i++) C[i]=A[i]*B[i]_;
        FMT(C,-1);
        return C;
    }
}

ll N;

int main(){
    freopen(&quot;gcdconv.in&quot;,&quot;r&quot;,stdin);
    freopen(&quot;gcdconv_std.out&quot;,&quot;w&quot;,stdout);
    N=Rd();
    LinearSieve(N);
    Poly A(N),B(N);
    for(ll i=1;i&lt;=N;i++) A[i]=Rd();
    for(ll i=1;i&lt;=N;i++) B[i]=Rd();
    Poly C=PC::GcdConv(A,B);
    ll ans=0;
    for(ll i=1;i&lt;=N;i++) ans^=C[i];
    printf(&quot;%lld&quot;,ans);
    return 0;
}</code></pre>
<h2 id="further-thoughts">Further Thoughts</h2>
<p>本题用到的是莫比乌斯反演的一种变形 <span class="math display">\[
g(n) = \sum_{n|d} f(n) \iff f(d) = \sum_{n|d} \mu(\frac n d) g(d)
\]</span> 原版莫比乌斯反演长这样 <span class="math display">\[
g(n) = \sum_{d|n} f(n) \iff f(d) = \sum_{d|n} \mu(\frac n d) g(d)
\]</span> 若把题目改成 <span class="math inline">\(\mathrm{lcm}\)</span>
卷积，即 <span class="math display">\[
h_k = \sum_{\mathrm{lcm}(i,j) = k} f_i g_j
\]</span>
用到的就是原版莫比乌斯反演。相应的构造一个“约数和变换”即可解决。而约数和变换可以用“快速约数和变换”（实际上就是个埃筛）实现，有兴趣的同学可以试试。</p>
<h2 id="further-further-thoughts-update-20201028">Further Further
Thoughts (update 2020/10/28)</h2>
<p>我们来探讨一些更加接近本质的东西。</p>
<p>普通卷积（多项式乘法）、集合并/交卷积、还有 <span
class="math inline">\(\mathrm{lcm}\)</span> / <span
class="math inline">\(\gcd\)</span>
卷积，这三个问题我们是如何解决的？</p>
<p>关键在于——我们分别构造出了离散傅里叶变换、子集和/超集和变换（莫比乌斯变换）和约数和/倍数和变换来满足卷积定理。</p>
<p>而这三个变换的共性在哪里呢？</p>
<p>他们都是偏序集上的具有优美性质的广义反演。</p>
<ul>
<li>离散傅里叶变换用的是单位根反演——其偏序集是定义在自然数集上的小于等于关系；</li>
<li>子集和/超集和变换用的是容斥原理——其偏序集是定义在集合上的包含关系；</li>
<li>而约数和/倍数和变换则运用了莫比乌斯反演——其偏序集是定义在自然数集上的整除关系。</li>
</ul>
<p>反演的意义就在于——它为将原来的“系数”转化为“点值”， <span
class="math inline">\(O(n)\)</span>
乘起来后又转回“系数”提供了可能。而这三个特殊的反演之所以优美，就是因为我们发现了他们的“快速
(Fast) ”变换方式，让我们能通过这个Trick，免去了 <span
class="math inline">\(O(n^2)\)</span> 的暴力运算。</p>
<p>还有更重要的一点——子集和/超集和变换与约数和/倍数和变换有着更加紧密的联系——这也是笔者由集合的FMT想到约数和变换的关键所在——以全体素数为基底可以张成一个包含全体正整数的“素数空间”（其良定义依赖于整数惟一分解定理）。</p>
<p>约数和变换就是“素数空间”中的高维前缀和，对应着“集合空间”中的子集和变换。换句话说，子集和变换、约数和变换分别是莫比乌斯变换在“素数空间”、“集合空间”的具体体现，它们的本质都是高维前缀和。</p>
<p>如果理解到上面这一点，就不难发现集合并卷积和 <span
class="math inline">\(\mathrm{lcm}\)</span>
卷积的共性了——他们都把数放到了对两个输入元素各维度坐标取 <span
class="math inline">\(\max\)</span> 后的位置；而集合交卷积和 <span
class="math inline">\(\gcd\)</span> 卷积则是取 <span
class="math inline">\(\min\)</span> 。</p>
<p>综上所述，有了上面的认识，可以说 <span
class="math inline">\(\gcd\)</span> 卷积的发现是非常自然的。</p>
<h2 id="后记-致谢">后记 &amp; 致谢</h2>
<p><del>Idea是在语文课上摸出来的，Solution是在随后的数学课上想出来的</del></p>
<p>很早以前就觉得FMT和莫比乌斯反演有些说不清道不明的关系，出这道题也让笔者对其理解更加深入了。</p>
<p>其实早有大佬对 <span class="math inline">\(\mathrm{lcm}\)</span> /
<span class="math inline">\(\gcd\)</span>
卷积展开过研究。Google一波可以发现国外数学社区有这方面的讨论，最晚2013年arXiv上就有讨论其性质的论文了（笔者驽钝，确实无力理解，感兴趣的大佬可以直接Google
"GCD Convolution"了解）。只可惜如此自然而美妙的 <span
class="math inline">\(\gcd\)</span>
卷积，竟然没有随着那篇集合幂级数的论文引入国内，让笔者感到有些遗憾。</p>
<p>总之，这道题深入的考察对FFT、FMT原理的理解以及对 <span
class="math inline">\(\gcd\)</span>
、莫比乌斯反演的敏锐直觉，<del>是不可多得的数论好题（</del></p>
<p>下面是战术感谢环节。</p>
<p>感谢keke学长为我们教授集合幂级数。</p>
<p>感谢TbYangZ、diong神、changruinian2020几位神仙的点拨。</p>
<p>And you...</p>
<p style="text-align: right">
——sun123zxy
</p>
<p style="text-align: right">
Sep. 2020 初稿完成
</p>
<p style="text-align: right">
Nov. 2020 最后更新
</p>
<p><strong>Next Phantasm...</strong></p>
</div>
    <div class="post-tags text-vice" style="text-align: right">
        <p>tags: 
            
                <a href= "/tags#OI" >OI</a>, 
            
                <a href= "/tags#数学" >数学</a>, 
            
                <a href= "/tags#原创题目" >原创题目</a>, 
            
                <a href= "/tags#题解" >题解</a>, 
            
                <a href= "/tags#学习笔记" >学习笔记</a>
            
        </p>
        <p>posted on 2020/12/06 | last modified on 2020/12/06</p>
    </div>
    
        <div class="post-comments">
            <script src="https://giscus.app/client.js"
                data-repo="sun123zxy/sun123zxy.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnkzMTAwMzQxNDc="
                data-category="General"
                data-category-id="DIC_kwDOEnq-484CQKFr"
                data-mapping="pathname"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="en"
                crossorigin="anonymous">
            </script>
        </div>
    
</div>
    </div>
    <div id="sidebar">
        
            <div id="sidebar-profile" class="panel">
                
                <div class="panel-content">
                    <a href="/"><img class="avatar" src="/assets/images/pig.png"></img></a>
<p class="nickname">sun123zxy</p>
<div class="nav">
    <a href="/">Home</a> | 
    <a href="/p/aboutme">About</a> | 
    <a href="/tags">Tags</a>
</div>
<div class="feed">
    <img src="/assets/images/feed.png"></img>
    <a href="/feed.xml">Atom Feed</a>
</div>
<p>Next Phantasm...</p>
                </div>
            </div>
        
            <div id="sidebar-news" class="panel">
                
                <h2 class="panel-title">News</h2>
                
                <div class="panel-content">
                    <a href="https://info.flagcounter.com/1Zpv"><img src="https://s05.flagcounter.com/count2/1Zpv/bg_DDDDDD/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_3/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>

<p>博客已迁移。访问 <a href="https://blog.sun123zxy.top">blog.sun123zxy.top</a> 获取更多信息。</p>
                </div>
            </div>
        
            <div id="sidebar-links" class="panel">
                
                <h2 class="panel-title">Links</h2>
                
                <div class="panel-content">
                    
<h3>My Friends</h3>
<ul>
    <li><a href="https://www.cnblogs.com/Railgunforever">吸取教训</a></li>
    <li><a href="https://p9t6g.github.io">p9t6g</a></li>
    <li><a href="https://tbyangz.github.io">TbYangZ</a></li>
    <li><a href="https://www.cnblogs.com/ALANALLEN21LOVE28">CJ SYH</a></li>
</ul>

<h3>Related Sites</h3>
<ul>
    <li><a href="http://www.cnblogs.com/sun123zxy">博客园</a></li>
    <li><a href="http://tools.sun123zxy.top">工具站</a></li>
</ul>
                </div>
            </div>
        
            <div id="sidebar-tags" class="panel">
                
                <h2 class="panel-title">Tags</h2>
                
                <div class="panel-content">
                    <ul>
    
    <li><a href= "/tags#OI" >OI</a></li>
    
    <li><a href= "/tags#数学" >数学</a></li>
    
    <li><a href= "/tags#高考" >高考</a></li>
    
    <li><a href= "/tags#题解" >题解</a></li>
    
    <li><a href= "/tags#原创题目" >原创题目</a></li>
    
    <li><a href= "/tags#学习笔记" >学习笔记</a></li>
    
    <li><a href= "/tags#意识流" >意识流</a></li>
    
    <li><a href= "/tags#游记" >游记</a></li>
    
    <li><a href= "/tags#Web" >Web</a></li>
    
    <li><a href= "/tags#站点相关" >站点相关</a></li>
    
    <li><a href= "/tags#Python" >Python</a></li>
    
</ul>
                </div>
            </div>
        
        
            <div id="contents" class="panel"><h2 class="panel-title">Contents</h2>
<div class="panel-content"></div>
<script defer src="/assets/js/contents.js"></script></div>
        
    </div>
    <div class="fclean"></div>
    <div id="footer" class="text-vice">
        <p>sun123zxy's Blog | Powered by Jekyll</p>
    </div>
</div>
<div id="leftdown-float-container">
    <div id="theme-info" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/info.png"></img></div>
        <div class="hover-info">Theme Info</div>
    </div>
    <div id="theme-switch" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/switch.png"></img></div>
        <div class="hover-info">Theme Switch</div>
    </div>
</div>
<div id="rightdown-float-container">
    <div id="music-player" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/music.png"></img></div>
        <div class="hover-info">Music Player</div>
    </div>
</div>
<link rel="stylesheet" href="/assets/css/default.css">
<link rel="stylesheet" id="night-container">
<link rel="stylesheet" id="theme-container">
<div id="mask"></div>
<script src="/assets/js/theme_data.js"></script>
<script src="/assets/js/round_button.js"></script>
<script src="/assets/js/theme_manager.js" defer></script>
<script src="/assets/js/music_player.js"></script>
<script src="/assets/js/scroll.js"></script>
    </body>
</html>