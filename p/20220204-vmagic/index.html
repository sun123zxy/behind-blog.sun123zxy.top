<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>DockerCompose+VLESS+WS+TLS+Web 方式搭建 V2Ray 代理 - sun123zxy's Blog</title>

        <script src="/assets/thirds/jquery/jquery-3.5.1.min.js"></script>

        <link rel="stylesheet" href="/assets/thirds/katex/katex.min.css">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="/assets/thirds/katex/katex.min.js"></script>
        <!-- To automatically render math in text elements, include the auto-render extension -->
        <script defer src="/assets/thirds/katex/auto-render.min.js" onload="renderMathInElement(document.body)"></script>
        
        <script src="/assets/thirds/highlight/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
    </head>
    <body>
        <div id="home">
    <div id="main" class="panel panel-content">
        <div class="post-body">
    <div class="post-head">
        <h1 id="post-title">DockerCompose+VLESS+WS+TLS+Web 方式搭建 V2Ray 代理</h1>
        <p class="abstract text-vice">
            
                无懈可击的超强配置搭建教程。
            
        </p>
    </div>
    <div class="post-content"><p>全文参考：</p>
<ul>
<li><a href="https://guide.v2fly.org/advanced/wss_and_web.html">(VMESS)
+ WebSocket + TLS + Web | 新 V2Ray 白话文指南</a></li>
<li><a
href="https://guide.v2fly.org/app/docker-deploy-v2ray.html">Docker 部署
V2Ray | 新 V2Ray 白话文指南</a></li>
<li><a href="https://www.v2fly.org/">V2Ray(V2Fly) 官方文档</a></li>
</ul>
<h2 id="原理">原理</h2>
<p>VLESS 作为内部传输协议，使用 HTTP 的扩展 WebSocket
作为传输载体，外层使用 TLS 加密传输。服务器端用 Nginx 搭建正常 HTTPS
网站，收到向特定路径发送的 WebSocket 流量时充当反向代理转发至 Docker
容器内的 V2Ray 处理。</p>
<p>从外部看，服务器是货真价实的 HTTPS
服务器，客户端发出的请求也是货真价实的 HTTPS
流量；直接用浏览器访问入口路径将返回 <code>400 Bad Request</code>（由
V2Ray 返回）或 <code>404 Not Found</code>（可在 Nginx 中预检测 WebSocket
请求，增强隐蔽性）；安全性、抗干扰能力则完全由 TLS
保障，几乎无懈可击。</p>
<p>更强的技术还有 Xray 中使用的 XTLS，无缝拼接了内外两层 TLS
使得性能进一步提高。不过因为和 V2Ray 主社区分离了，还是决定先用
VLESS+WS+TLS+Web 配置。</p>
<ul>
<li><a href="https://tlanyan.pp.ua/xray-tutorial/">V2Ray V2Fly Xray
的历史</a></li>
</ul>
<p>结构上，使用 Docker 和 Docker Compose
容器化安装方便管理；而装在外层的 Nginx
可以作为所有网页服务的入口点，方便以后增加其它服务。</p>
<h2 id="流程">流程</h2>
<p>以下所有操作在 Ubuntu 20.04 的 root
用户下进行。代码中部分需要自己填写的敏感信息会用如
<code>{[VARIABLE]}</code> 的记号标明，请自行替换。</p>
<h3 id="准备工作">准备工作</h3>
<h4 id="安装-curl">安装 cURL</h4>
<pre class="bash"><code>apt install curl</code></pre>
<h4 id="安装-docker">安装 Docker</h4>
<pre class="bash"><code>curl -fsSL https://get.docker.com/ | sh # 获取脚本并交给 sh (shell) 执行
systemctl start docker</code></pre>
<h4 id="安装-docker-compose">安装 Docker Compose</h4>
<pre class="bash"><code>curl -L https://github.com/docker/compose/releases/download/1.25.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
# docker-compose --version</code></pre>
<h4 id="安装并运行-nginx">安装并运行 Nginx</h4>
<pre class="bash"><code>apt install nginx
systemctl start nginx</code></pre>
<p>此时通过浏览器访问服务器就能看到 Nginx 默认的欢迎界面了。</p>
<h4 id="调试技巧">调试技巧</h4>
<p>Nginx 的日志存储在 <code>/var/log/nginx</code> 目录下；V2Ray 的日志在
Docker 容器里，之后我们将把它映射到宿主机上方便操作和存储。</p>
<p>一些常用的调试命令：</p>
<pre class="bash"><code>systemctl start nginx
systemctl status nginx
systemctl stop nginx

docker-compose up -d # Create and start containers（-d 表示后台运行）
docker-compose down  # Stop and remove containers, networks, images, and volumes
docker-compose start # Start services
docker-compose stop  # Stop services

docker ps # 查看各容器运行状态
docker log {[CONTAINER_ID]} # 查看某容器运行日志</code></pre>
<h3 id="安装-certbot-并以-webroot-方式获取-lets-encrypt-证书">安装
Certbot 并以 Webroot 方式获取 Let's Encrypt 证书</h3>
<ul>
<li>Certbot 官方教程：<a
href="https://eff-certbot.readthedocs.io/en/stable/using.html">User
Guide — Certbot 1.22.0 documentation</a></li>
<li>Certbot 原理：<a
href="https://www.jianshu.com/p/3ffd27b64847">HTTPS-使用Certbot自动配置Let’s
Encrypt证书 - 简书</a></li>
</ul>
<p>Let's Encrypt
是一个免费、自动化和开放的证书颁发机构，为网站提供免费的 SSL/TLS
证书。要从 Let's Encrypt
获取某个域名的证书，需要证明拥有对该域名的控制权，而 Certbot
就是官方提供的自动化认证工具。</p>
<p>Webroot 是 Certbot
提供的一种认证方式，如果服务器上有网站运行且有能力修改其配置，就可以用该方式进行认证。使用这种方式获取证书时无需暂停网页服务端的运行。</p>
<blockquote>
<p>The webroot plugin works by creating a temporary file for each of
your requested domains in
<code>${webroot-path}/.well-known/acme-challenge</code>. Then the Let’s
Encrypt validation server makes HTTP requests to validate that the DNS
for each requested domain resolves to the server running certbot.</p>
</blockquote>
<p>首先安装 Certbot：</p>
<pre class="bash"><code>apt install certbot python3-certbot</code></pre>
<p>因为之前安装的 Nginx 已经在 <code>/var/www/html</code>
下生成默认的欢迎页网站，故可直接利用该目录进行 Webroot 认证：</p>
<pre class="bash"><code>certbot certonly --webroot -w /var/www/html -d {[YOUR_DOMAIN]}</code></pre>
<p>认证过程中 Certbot 的回显信息：</p>
<pre class="text"><code>Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for {[YOUR_DOMAIN]}
Using the webroot path /var/www/html for all unmatched domains.
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/{[YOUR_DOMAIN]}/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/{[YOUR_DOMAIN]}/privkey.pem
   Your cert will expire on {[EXPIRE-DATE]}. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   &quot;certbot renew&quot;
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let&#39;s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le</code></pre>
<h3 id="使用-docker-compose-安装并配置-v2ray">使用 Docker Compose
安装并配置 V2Ray</h3>
<p>上传 <code>docker-compose.json</code>
至适当位置（建议妥善储存该文件，以便后续管理使用）：</p>
<pre class="yml"><code>version: &quot;3.4&quot;
services:
  v2ray:
    image: v2fly/v2fly-core
    container_name: v2ray
    restart: always # 自动重启容器
    ports: 
      - {[YOUR_PORT_OUTER]}:{[YOUR_PORT_INNER]} # 端口映射，注意外左内右
    command: v2ray -config=/etc/v2ray/config.json # 需要指定配置文件位置
    volumes:
      - /etc/v2ray:/etc/v2ray # 左边宿主目录，右边容器目录
      - /var/log/v2ray:/var/log/v2ray</code></pre>
<p>利用 volume 技术，容器中 V2Ray 的配置文件被映射到宿主机的
<code>/etc/v2ray</code> 目录下，而日志信息被映射到
<code>/var/log/v2ray</code> 目录下。</p>
<p>故运行容器之前，我们在 <code>/etc/v2ray</code> 下放置
<code>config.json</code> 作为容器内 V2Ray 的配置文件：</p>
<pre class="json"><code>{
    &quot;log&quot;: {
        &quot;loglevel&quot;: &quot;warning&quot;,
        &quot;access&quot;: &quot;/var/log/v2ray/access.log&quot;,
        &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;
    },
    &quot;inbounds&quot;: [
        {
            &quot;port&quot;: &quot;{[YOUR_PORT_INNER]}&quot;, // 容器内的监听端口
            &quot;listen&quot;:&quot;0.0.0.0&quot;, // Caution!
            &quot;protocol&quot;: &quot;vless&quot;,
            &quot;settings&quot;: {
                &quot;decryption&quot;: &quot;none&quot;,
                &quot;clients&quot;: [
                    {
                        &quot;id&quot;: &quot;{[YOUR_UUID]}&quot;,
                        &quot;email&quot;: &quot;{[YOUR_EMAIL]}&quot; // 作标识用，可以随便填
                    }
                ]
            },
            &quot;streamSettings&quot;: {
                &quot;network&quot;: &quot;ws&quot;,
                &quot;wsSettings&quot;: {
                    &quot;path&quot;: &quot;{[YOUR_PATH]}&quot; // 希望设定的 V2Ray 入口路径，如 &quot;/ray&quot;
                }
            }
        }
    ],
    &quot;outbounds&quot;: [
        {
            &quot;protocol&quot;: &quot;freedom&quot;,
            &quot;settings&quot;: {}
        }
    ]
}</code></pre>
<blockquote>
<p>有一个小坑点（见 <a
href="https://github.com/v2ray/v2ray-core/issues/2221">Issue
#2221</a>）：与白话文指南不同，如果用 Docker 搭建 V2Ray，容器外的 Nginx
需要向容器内的 V2Ray 发送数据，因此容器内的 V2Ray 必须监听本机 IP
<code>0.0.0.0</code> 而不是本地回环 IP <code>127.0.0.1</code>。</p>
<p>常见的症状是客户端报
<code>502 Bad Gateway &gt; websocket: bad handshake</code> ，Nginx 报
<code>upstream prematurely closed connection</code>，而容器内 V2Ray
没有报警日志。</p>
</blockquote>
<p>最后，在之前放置 <code>docker-compose.yml</code> 的目录下执行：</p>
<pre class="bash"><code>docker-compose up -d</code></pre>
<h3 id="设置-nginx-反向代理">设置 Nginx 反向代理</h3>
<ul>
<li><a
href="http://nginx.org/en/docs/http/configuring_https_servers.html">Nginx
- Configuring HTTPS servers</a></li>
<li><a
href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html">Nginx -
Module ngx_http_ssl_module</a></li>
</ul>
<p>通常修改 Nginx 配置可以通过直接修改
<code>/etc/nginx/nginx.conf</code> 或在 <code>/etc/nginx/conf.d/</code>
目录下新建配置文件的方式进行，但根据推荐的目录结构（参见 <a
href="https://wiki.debian.org/Nginx/DirectoryStructure">Nginx/DirectoryStructure
- Debian Wiki</a>），这里选择在 <code>/etc/nginx/sites-available/</code>
放置配置文件后在 <code>/etc/nginx/sites-enabled/my-enabled.conf</code>
中动态引用。</p>
<p>故首先在 <code>/etc/nginx/sites-available/</code> 下新建
<code>{[YOUR_DOMAIN]}.conf</code>（文件名可自行调整）：</p>
<pre class="nginx"><code>server {
  listen 443 ssl;
  listen [::]:443 ssl;

  ssl_certificate       /etc/letsencrypt/live/{[YOUR_DOMAIN]}/fullchain.pem;
  ssl_certificate_key   /etc/letsencrypt/live/{[YOUR_DOMAIN]}/privkey.pem;
  # 利用缓存重用 session 提高性能
  ssl_session_timeout 1d;
  ssl_session_cache shared:MozSSL:10m;
  ssl_session_tickets off;

  ssl_protocols         TLSv1.2 TLSv1.3;
  # 设置加密方式，默认的已经不安全了
  ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off; # (?) Specifies that server ciphers should be preferred over client ciphers when using the SSLv3 and TLS protocols.

  server_name           {[YOUR_DOMAIN]};
  location {[YOUR_PATH]} { # 与 V2Ray 配置中的 path 保持一致
    if ($http_upgrade != &quot;websocket&quot;) { # WebSocket 协商失败时返回 404
        return 404;
    }
    proxy_redirect off;
    proxy_pass http://127.0.0.1:{[YOUR_PORT_OUTER]}; # 设置反向代理转发至 V2Ray
    proxy_http_version 1.1;
    # 一些 WebSocket 需要的配置
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection &quot;upgrade&quot;;
    proxy_set_header Host $host;
    # Show real IP in v2ray access.log
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
# modified from (2022/01/30) https://guide.v2fly.org/advanced/wss_and_web.html#nginx-%E9%85%8D%E7%BD%AE</code></pre>
<p>然后在 <code>/etc/nginx/sites-enabled/</code> 目录下，先删除原有的
<code>default</code> 文件，然后新建
<code>my-enabled.conf</code>（文件名可自行调整）：</p>
<pre class="nginx"><code>include /etc/nginx/sites-available/default; # 继续使用 Nginx 的默认站点配置文件
include /etc/nginx/sites-available/{[YOUR_DOMAIN]}.conf; # 引用刚刚新建的配置文件</code></pre>
<ul>
<li>Update: 实际上推荐的方式是用 <code>ln -s</code> 在
<code>/etc/nginx/sites-enabled/</code> 里创建 symbolic
link，当时搞的时候还不太懂，是我 naive 了（</li>
</ul>
<p>最后重新加载配置文件：</p>
<pre class="bash"><code>nginx -s reload</code></pre>
<h3 id="客户端">客户端</h3>
<p><del>用的图形化界面还没研究配置文件</del>，不过 outbounds
部分大致应如下所示：</p>
<pre class="json"><code>&quot;outbounds&quot;: [
    {
        &quot;protocol&quot;: &quot;vless&quot;,
        &quot;settings&quot;: {
            &quot;vnext&quot;: [
                {
                    &quot;address&quot;: &quot;{[YOUR_DOMAIN]}&quot;,
                    &quot;port&quot;: 443,
                    &quot;users&quot;: [
                        {&quot;id&quot;: &quot;{[YOUR_UUID]}&quot;, &quot;email&quot;: &quot;{[YOUR_EMAIL]}&quot;}
                    ]
                }
            ]
        },
        &quot;streamSettings&quot;: {
            &quot;network&quot;: &quot;ws&quot;,
            &quot;security&quot;: &quot;tls&quot;,
            &quot;wsSettings&quot;: {
                &quot;path&quot;: &quot;{[YOUR_PATH]}&quot;
            }
        }
    }
]</code></pre>
</div>
    <div class="post-tags text-vice" style="text-align: right">
        <p>tags: 
            
                <a href= "/tags#Web" >Web</a>, 
            
                <a href= "/tags#学习笔记" >学习笔记</a>
            
        </p>
        <p>posted on 2022/02/04 | last modified on 2022/06/01</p>
    </div>
    
        <div class="post-comments">
            <script src="https://giscus.app/client.js"
                data-repo="sun123zxy/sun123zxy.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnkzMTAwMzQxNDc="
                data-category="General"
                data-category-id="DIC_kwDOEnq-484CQKFr"
                data-mapping="pathname"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="en"
                crossorigin="anonymous">
            </script>
        </div>
    
</div>
    </div>
    <div id="sidebar">
        
            <div id="sidebar-profile" class="panel">
                
                <div class="panel-content">
                    <a href="/"><img class="avatar" src="/assets/images/pig.png"></img></a>
<p class="nickname">sun123zxy</p>
<div class="nav">
    <a href="/">Home</a> | 
    <a href="/p/aboutme">About</a> | 
    <a href="/tags">Tags</a>
</div>
<div class="feed">
    <img src="/assets/images/feed.png"></img>
    <a href="/feed.xml">Atom Feed</a>
</div>
<p>Next Phantasm...</p>
                </div>
            </div>
        
            <div id="sidebar-news" class="panel">
                
                <h2 class="panel-title">News</h2>
                
                <div class="panel-content">
                    <a href="https://info.flagcounter.com/1Zpv"><img src="https://s05.flagcounter.com/count2/1Zpv/bg_DDDDDD/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_3/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>

<p>博客已迁移。访问 <a href="https://blog.sun123zxy.top">blog.sun123zxy.top</a> 获取更多信息。</p>
                </div>
            </div>
        
            <div id="sidebar-links" class="panel">
                
                <h2 class="panel-title">Links</h2>
                
                <div class="panel-content">
                    
<h3>My Friends</h3>
<ul>
    <li><a href="https://www.cnblogs.com/Railgunforever">吸取教训</a></li>
    <li><a href="https://p9t6g.github.io">p9t6g</a></li>
    <li><a href="https://tbyangz.github.io">TbYangZ</a></li>
    <li><a href="https://www.cnblogs.com/ALANALLEN21LOVE28">CJ SYH</a></li>
</ul>

<h3>Related Sites</h3>
<ul>
    <li><a href="http://www.cnblogs.com/sun123zxy">博客园</a></li>
    <li><a href="http://tools.sun123zxy.top">工具站</a></li>
</ul>
                </div>
            </div>
        
            <div id="sidebar-tags" class="panel">
                
                <h2 class="panel-title">Tags</h2>
                
                <div class="panel-content">
                    <ul>
    
    <li><a href= "/tags#OI" >OI</a></li>
    
    <li><a href= "/tags#数学" >数学</a></li>
    
    <li><a href= "/tags#高考" >高考</a></li>
    
    <li><a href= "/tags#题解" >题解</a></li>
    
    <li><a href= "/tags#原创题目" >原创题目</a></li>
    
    <li><a href= "/tags#学习笔记" >学习笔记</a></li>
    
    <li><a href= "/tags#意识流" >意识流</a></li>
    
    <li><a href= "/tags#游记" >游记</a></li>
    
    <li><a href= "/tags#Web" >Web</a></li>
    
    <li><a href= "/tags#站点相关" >站点相关</a></li>
    
    <li><a href= "/tags#Python" >Python</a></li>
    
</ul>
                </div>
            </div>
        
        
            <div id="contents" class="panel"><h2 class="panel-title">Contents</h2>
<div class="panel-content"></div>
<script defer src="/assets/js/contents.js"></script></div>
        
    </div>
    <div class="fclean"></div>
    <div id="footer" class="text-vice">
        <p>sun123zxy's Blog | Powered by Jekyll</p>
    </div>
</div>
<div id="leftdown-float-container">
    <div id="theme-info" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/info.png"></img></div>
        <div class="hover-info">Theme Info</div>
    </div>
    <div id="theme-switch" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/switch.png"></img></div>
        <div class="hover-info">Theme Switch</div>
    </div>
</div>
<div id="rightdown-float-container">
    <div id="music-player" class="round-button-handler">
        <div class="round-button"><img src="/assets/images/music.png"></img></div>
        <div class="hover-info">Music Player</div>
    </div>
</div>
<link rel="stylesheet" href="/assets/css/default.css">
<link rel="stylesheet" id="night-container">
<link rel="stylesheet" id="theme-container">
<div id="mask"></div>
<script src="/assets/js/theme_data.js"></script>
<script src="/assets/js/round_button.js"></script>
<script src="/assets/js/theme_manager.js" defer></script>
<script src="/assets/js/music_player.js"></script>
<script src="/assets/js/scroll.js"></script>
    </body>
</html>